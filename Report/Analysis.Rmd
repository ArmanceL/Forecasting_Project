---
title: "Analysis"
output: html_document
date: '2022-05-15'
---

```{r, echo = FALSE, message = FALSE}
source(here::here("Setup/setup.R"))
```

### Part 3 : Analysis 

```{r}
#library(visdat)
vis_miss(Gland_fin_tsibble)
```
We replace the last missing values by 0 as there are very few.
```{r}
Gland_fin_tsibble <- mutate_if(Gland_fin_tsibble, is.integer, ~replace(., is.na(.), 0))
Gland_fin_tsibble <- mutate_if(Gland_fin_tsibble, is.numeric, ~replace(., is.na(.), 0))
```

# 1. Gland Les Tuillières

We do an STL decomposition for *Bikes* in the station "Les Tuillières", to see any seasonality or trend in the time series. We then apply an ETS forecast with no trend and no seasonality. 

```{r}
#ETS Decomposition Bike data 
dcmp <- Gland_fin_tsibble %>% model(STL(Bike_Les_Tuillières))
components(dcmp) %>% autoplot() + xlab("Date")
```

```{r}
#ETS forecast
fit1 <- Gland_fin_tsibble %>%
model(ETS(Bike_Les_Tuillières ~ error("A") + trend("N") + season("N"), opt_crit = "mse"))
coefficients(fit1)
```

According to the fit, we should set alpha = 0.99, which is exactly equal to the naive model, so the latest observation.
```{r}
FIT1 <- Gland_fin_tsibble %>%
model(ETS(Bike_Les_Tuillières ~ error("A") + trend("N", alpha=0.99) + season("N")))
FIT1 %>% forecast(h = 144) %>% autoplot(Gland_fin_tsibble) +
theme(legend.position = "none")
FIT1%>%accuracy()
```

We now apply the Mean, the Naive and the S_Naive models. 
```{r}
mean_model1 <- Gland_fin_tsibble %>% model( Mean = MEAN(Bike_Les_Tuillières),
Naive = NAIVE(Bike_Les_Tuillières),
S_Naive = SNAIVE(Bike_Les_Tuillières))

forecast_mean_model1 <- mean_model1 %>% forecast(h = 144) 
forecast_mean_model %>% autoplot(Gland_fin_tsibble, level = NULL) + guides(colour=guide_legend(title = "Forecast"))
```
We do the same for the *E_Bike* data, with an STL decomposition and an ETS forecast. 
```{r}
#STL Decomposition Bike data 
dcmp <- Gland_fin_tsibble %>% model(STL(Ebike_Les_Tuillières))
components(dcmp) %>% autoplot() + xlab("Date")
```

```{r}
#ETS forecast
fit.1 <- Gland_fin_tsibble %>%
model(ETS(Ebike_Les_Tuillières ~ error("A") + trend("N") + season("N"), opt_crit = "mse"))
coefficients(fit.1)
```
According to the fit, we should set alpha = 0.99, which is exactly equal to the naive model, so the latest observation.

```{r}
FIT.1 <- Gland_fin_tsibble %>%
model(ETS(Ebike_Les_Tuillières ~ error("A") + trend("N", alpha=0.99) + season("N")))
FIT.1 %>% forecast(h = 144) %>% autoplot(Gland_fin_tsibble) +
theme(legend.position = "none")
FIT.1%>%accuracy()
```

We also apply the Mean, the Naive and the S_Naive models. 
```{r}
mean_model.1 <- Gland_fin_tsibble %>% model( Mean = MEAN(Ebike_Les_Tuillières),
Naive = NAIVE(Ebike_Les_Tuillières),
S_Naive = SNAIVE(Ebike_Les_Tuillières))

forecast_mean_model.1 <- mean_model.1 %>% forecast(h = 144) 
forecast_mean_model %>% autoplot(Gland_fin_tsibble, level = NULL) + guides(colour=guide_legend(title = "Forecast"))
```

We now fit a multiple linear regression of Bikes with temperatures and precipitations. 
```{r}
fit.BikeTempPreLT <- Gland_fin_tsibble %>%
model(tslm = TSLM(Bike_Les_Tuillières ~ temp + prec + ensoll + vent + press))
report(fit.BikeTempPreLT)
```
The R squares is low (0,0854) but precipitation seems to be correlated. However it is not very logical that precipitation is positively correlated with the number of bikes borrowed in the station since the rain should normally not increase this number and rather decrease it. 
```{r}
fit.EBikeTempPreLT <- Gland_fin_tsibble %>%
model(tslm = TSLM(Ebike_Les_Tuillières ~ temp + prec + ensoll + vent + press))
report(fit.EBikeTempPreLT)
```
Here, for E_Bikes the results seem more convincing since precipitation is negatively correlated with the number of E_bikes borrowed. However, the temperature and sunlight are as well. 

Let's see the correlation between these weather variables and Bikes at Les Tuillières
```{r}
Gland_fin_tsibble %>% GGally::ggpairs(columns = c(23,35:39))
```
The number of borrowed bikes at Les Tuillières seems negatively correlated with pressure (-0,282***).

Let's see the correlation between these weather variables and E_Bikes at Les Tuillières.
```{r}
Gland_fin_tsibble %>% GGally::ggpairs(columns = c(24,35:39))
```

The number of borrowed E_bikes at Les Tuillières seems also correlated with pressure (0,165***) but negatively correlated with the others.

Here is a forecast with TSLM() on Bike 
```{r}
#fit.BikeTempPreLT <- Gland_fin_tsibble %>% model(TSLM(Bike_Les_Tuillières ~ trend() + season()))
fc.BikeTempPreLT <- forecast(fit.BikeTempPreLT, h=144)
fc.BikeTempPreLT %>% autoplot(Gland_fin_tsibble) + xlab("Date") + ylab("Bike_LesTuillieres")

fit.BikeTempPreLT %>% gg_tsresiduals()
```

Here is a forecast with TSLM() on EBike 
```{r}
#fit.EBikeTempPreLT <- Gland_fin_tsibble %>% model(TSLM(Ebike_Les_Tuillières ~ trend() + season()))
fc.EBikeTempPreLT <- forecast(fit.EBikeTempPreLT, h=144)
fc.EBikeTempPreLT %>% autoplot(Gland_fin_tsibble) + xlab("Date") + ylab("E_Bike_LesTuillieres")

fit.EBikeTempPreLT %>% gg_tsresiduals()
```


ARIMA model on Bike and Ebike 

```{r}
fitLT <- Gland_fin_tsibble %>%  model(ARIMA(Bike_Les_Tuillières))
report(fitLT)
fitLT %>% forecast(h = 144) %>% autoplot(Gland_fin_tsibble)

fit.LT <- Gland_fin_tsibble %>%  model(ARIMA(Ebike_Les_Tuillières))
report(fit.LT)
fit.LT %>% forecast(h = 144) %>% autoplot(Gland_fin_tsibble)
```

Dynamic regression with temperature. 

```{r}
Gland_fin_tsibble %>% gather("var", "value", Bike_Les_Tuillières, temp) %>%
ggplot(aes(x = Date, y = value)) + geom_line() +
facet_grid(vars(var), scales = "free_y") +
labs(y = "", title = "Number of bikes borrowed every 10 minutes in Gland Les Tuillières")

fitDR_LT <- Gland_fin_tsibble %>% model(ARIMA(Bike_Les_Tuillières ~ temp))
report(fitDR_LT)

bind_rows( 'Regression Errors' = as_tibble(residuals(fitDR_LT, type = "regression")), 'ARIMA Errors' = as_tibble(residuals(fitDR_LT, type = "innovation")), .id = "type") %>%
ggplot(aes(x = Date, y = .resid)) + geom_line() + facet_grid(vars(type), scales = "free_y") + labs(y = "")

fitDR_LT %>% gg_tsresiduals()

future_Gland_fin_tsibble1 <- new_data(Gland_fin_tsibble, 144) %>% mutate(temp = mean(Gland_fin_tsibble$temp)) 
forecast(fitDR_LT, new_data = future_Gland_fin_tsibble1, h = 144) %>% autoplot(Gland_fin_tsibble) +
labs(y = "Forecast of the number of bikes borrowed every 10 minutes in Gland Les Tuillières") 
```


```{r}
Gland_fin_tsibble %>% gather("var", "value", Ebike_Les_Tuillières, temp) %>%
ggplot(aes(x = Date, y = value)) + geom_line() +
facet_grid(vars(var), scales = "free_y") +
labs(y = "", title = "Number of Ebikes borrowed every 10 minutes in Gland Les Tuillières")

fitDR_eLT <- Gland_fin_tsibble %>% model(ARIMA(Ebike_Les_Tuillières ~ temp))
report(fitDR_eLT)

bind_rows( 'Regression Errors' = as_tibble(residuals(fitDR_eLT, type = "regression")), 'ARIMA Errors' = as_tibble(residuals(fitDR_eLT, type = "innovation")), .id = "type") %>%
ggplot(aes(x = Date, y = .resid)) + geom_line() + facet_grid(vars(type), scales = "free_y") + labs(y = "")

fitDR_eLT %>% gg_tsresiduals()

future_Gland_fin_tsibble.1 <- new_data(Gland_fin_tsibble, 144) %>% mutate(temp = mean(Gland_fin_tsibble$temp)) 
forecast(fitDR_eLT, new_data = future_Gland_fin_tsibble.1, h = 144) %>% autoplot(Gland_fin_tsibble) +
labs(y = "Forecast of the number of Ebikes borrowed every 10 minutes in Gland Les Tuillières") 
```

--> Try dynamic regression with other weather variables


VAR model 
```{r}

```

GEM model 
```{r}

```









# 2. Gland Swissquote


We do an STL decomposition for *Bikes* in the station "Swissquote", to see any seasonality or trend in the time series. 

```{r}
#ETS Decomposition Bike data 
dcmp <- Gland_fin_tsibble %>% model(STL(Bike_Swissquote))
components(dcmp) %>% autoplot() + xlab("Date")
```

We then apply an ETS forecast with no trend and no seasonality. 

```{r}
#ETS forecast
fit2 <- Gland_fin_tsibble %>%
model(ETS(Bike_Swissquote ~ error("A") + trend("N") + season("N"), opt_crit = "mse"))
coefficients(fit2)
```

According to the fit, we should set alpha = 1. 
```{r}
FIT2 <- Gland_fin_tsibble %>%
model(ETS(Bike_Swissquote ~ error("A") + trend("N", alpha=0.99) + season("N")))
FIT2 %>% forecast(h = 144) %>% autoplot(Gland_fin_tsibble) +
theme(legend.position = "none")
FIT2%>%accuracy()
```

We now apply the Mean, the Naive and the S_Naive models. 
```{r}
mean_model2 <- Gland_fin_tsibble %>% model( Mean = MEAN(Bike_Swissquote),
Naive = NAIVE(Bike_Swissquote),
S_Naive = SNAIVE(Bike_Swissquote))

forecast_mean_model2 <- mean_model2 %>% forecast(h = 144) 
forecast_mean_model %>% autoplot(Gland_fin_tsibble, level = NULL) + guides(colour=guide_legend(title = "Forecast"))
```
We do the same for the *E_Bike* data, with an STL decomposition and an ETS forecast. 
```{r}
#STL Decomposition Bike data 
dcmp <- Gland_fin_tsibble %>% model(STL(Ebike_Swissquote))
components(dcmp) %>% autoplot() + xlab("Date")
```
We then apply an ETS forecast with no trend and an additive seasonality (season_week, season_day, season_hour ?)
```{r}
#ETS forecast
fit.2 <- Gland_fin_tsibble %>%
model(ETS(Ebike_Swissquote ~ error("A") + trend("N") + season("A"), opt_crit = "mse"))
coefficients(fit.2)
```
According to the fit, we should set alpha = 0.98.

```{r}
FIT.2 <- Gland_fin_tsibble %>%
model(ETS(Ebike_Swissquote ~ error("A") + trend("N", alpha=0.98) + season("A")))
FIT.2 %>% forecast(h = 144) %>% autoplot(Gland_fin_tsibble) +
theme(legend.position = "none")
FIT.2%>%accuracy()
```

We also apply the Mean, the Naive and the S_Naive models. 
```{r}
mean_model.2 <- Gland_fin_tsibble %>% model( Mean = MEAN(Ebike_Swissquote),
Naive = NAIVE(Ebike_Swissquote),
S_Naive = SNAIVE(Ebike_Swissquote))

forecast_mean_model.2 <- mean_model.2 %>% forecast(h = 144) 
forecast_mean_model %>% autoplot(Gland_fin_tsibble, level = NULL) + guides(colour=guide_legend(title = "Forecast"))
```

We now fit a multiple linear regression of Bikes with temperatures and precipitations. 
```{r}
fit.BikeTempPreS <- Gland_fin_tsibble %>%
model(tslm = TSLM(Bike_Swissquote ~ temp + prec + ensoll + vent + press))
report(fit.BikeTempPreS)
```
The R squares is low (0,135) but precipitation seems to be correlated. However it is not very logical that precipitation is positively correlated with the number of bikes borrowed in the station since the rain should normally not increase this number and rather decrease it. 
```{r}
fit.EBikeTempPreS <- Gland_fin_tsibble %>%
model(tslm = TSLM(Ebike_Swissquote ~ temp + prec + ensoll + vent + press))
report(fit.EBikeTempPreS)
```
Here, for E_Bikes the results seem more convincing since precipitation is negatively correlated with the number of E_bikes borrowed. Moreover, the sunlight is positively correlated. 

Let's see the correlation between these weather variables and Bikes at Swissquote.
```{r}
Gland_fin_tsibble %>% GGally::ggpairs(columns = c(29,35:39))
```
The number of borrowed bikes at Swissquote seems positively correlated with pressure (0,227***) and the wind.

Let's see the correlation between these weather variables and E_Bikes at Swissquote.
```{r}
Gland_fin_tsibble %>% GGally::ggpairs(columns = c(30,35:39))
```

The number of borrowed E_bikes at Swissquote seems correlated with sunlight and temperature.

Here is a forecast with TSLM() on Bike 
```{r}
#fit.BikeTempPreLT <- Gland_fin_tsibble %>% model(TSLM(Bike_Les_Tuillières ~ trend() + season()))
fc.BikeTempPreLT <- forecast(fit.BikeTempPreLT, h=144)
fc.BikeTempPreLT %>% autoplot(Gland_fin_tsibble) + xlab("Date") + ylab("Bike_LesTuillieres")

fit.BikeTempPreLT %>% gg_tsresiduals()
```

Here is a forecast with TSLM() on EBike 
```{r}
#fit.EBikeTempPreLT <- Gland_fin_tsibble %>% model(TSLM(Ebike_Les_Tuillières ~ trend() + season()))
fc.EBikeTempPreLT <- forecast(fit.EBikeTempPreLT, h=144)
fc.EBikeTempPreLT %>% autoplot(Gland_fin_tsibble) + xlab("Date") + ylab("E_Bike_LesTuillieres")

fit.EBikeTempPreLT %>% gg_tsresiduals()
```


ARIMA model on Bike and Ebike 

```{r}
fitS <- Gland_fin_tsibble %>%  model(ARIMA(Bike_Swissquote))
report(fitS)
fitS %>% forecast(h = 144) %>% autoplot(Gland_fin_tsibble)

fit.S <- Gland_fin_tsibble %>%  model(ARIMA(Ebike_Swissquote))
report(fit.S)
fit.S %>% forecast(h = 144) %>% autoplot(Gland_fin_tsibble)
```

Dynamic regression with temperature 

```{r}
Gland_fin_tsibble %>% gather("var", "value", Bike_Swissquote, temp) %>%
ggplot(aes(x = Date, y = value)) + geom_line() +
facet_grid(vars(var), scales = "free_y") +
labs(y = "", title = "Number of bikes borrowed every 10 minutes in Gland Swissquote")

fitDR_S <- Gland_fin_tsibble %>% model(ARIMA(Bike_Swissquote ~ temp))
report(fitDR_S)

bind_rows( 'Regression Errors' = as_tibble(residuals(fitDR_S, type = "regression")), 'ARIMA Errors' = as_tibble(residuals(fitDR_S, type = "innovation")), .id = "type") %>%
ggplot(aes(x = Date, y = .resid)) + geom_line() + facet_grid(vars(type), scales = "free_y") + labs(y = "")

fitDR_S %>% gg_tsresiduals()

future_Gland_fin_tsibble2 <- new_data(Gland_fin_tsibble, 144) %>% mutate(temp = mean(Gland_fin_tsibble$temp)) 
forecast(fitDR_S, new_data = future_Gland_fin_tsibble2, h = 144) %>% autoplot(Gland_fin_tsibble) +
labs(y = "Forecast of the number of bikes borrowed every 10 minutes in Gland Swissquote") 
```


```{r}
Gland_fin_tsibble %>% gather("var", "value", Ebike_Swissquote, temp) %>%
ggplot(aes(x = Date, y = value)) + geom_line() +
facet_grid(vars(var), scales = "free_y") +
labs(y = "", title = "Number of Ebikes borrowed every 10 minutes in Gland Swissquote")

fitDR_eS <- Gland_fin_tsibble %>% model(ARIMA(Ebike_Swissquote ~ temp))
report(fitDR_eS)

bind_rows( 'Regression Errors' = as_tibble(residuals(fitDR_eS, type = "regression")), 'ARIMA Errors' = as_tibble(residuals(fitDR_eS, type = "innovation")), .id = "type") %>%
ggplot(aes(x = Date, y = .resid)) + geom_line() + facet_grid(vars(type), scales = "free_y") + labs(y = "")

fitDR_eS %>% gg_tsresiduals()

future_Gland_fin_tsibble.2 <- new_data(Gland_fin_tsibble, 144) %>% mutate(temp = mean(Gland_fin_tsibble$temp)) 
forecast(fitDR_eS, new_data = future_Gland_fin_tsibble.2, h = 144) %>% autoplot(Gland_fin_tsibble) +
labs(y = "Forecast of the number of Ebikes borrowed every 10 minutes in Gland Swissquote") 
```















# 3. Gland Gare Sud

# 4. Gland UICN

# 5. Gland Montoly

# 6. Gland Grande Rue


# 7. Gland La Falaise


# 8. Gland La Liginière


# 9. Gland Eiekenott

# 10. Gland La Dôle


# 11. Gland En Bord
